<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSTONES - Data Migration</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background: #f5f7fa; padding: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { font-size: 24px; margin-bottom: 24px; color: #1a1a2e; }
        .card { background: white; border-radius: 12px; padding: 32px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 24px; }
        .btn { padding: 12px 32px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; }
        .btn--primary { background: #a98aca; color: white; }
        .btn--primary:hover { background: #9370b8; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #log { font-family: monospace; font-size: 13px; background: #1a1a2e; color: #a98aca; padding: 20px; border-radius: 8px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
        .step { margin-bottom: 16px; }
        .step h3 { font-size: 16px; margin-bottom: 8px; }
        .step p { font-size: 14px; color: #666; }
        .warning { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 16px; margin-bottom: 24px; font-size: 14px; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Data Migration Tool</h1>

        <div class="warning">
            This tool migrates existing portfolio.json data to Firebase Firestore.
            Make sure you have set up Firebase and updated firebase-config.js before proceeding.
            You must be logged in as admin to write data.
        </div>

        <div class="card">
            <div class="step">
                <h3>Step 1: Login</h3>
                <p>Login with your admin credentials first.</p>
                <br>
                <input type="email" id="email" placeholder="Email" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; margin-right:8px;">
                <input type="password" id="password" placeholder="Password" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; margin-right:8px;">
                <button class="btn btn--primary" id="btn-login" onclick="doLogin()">Login</button>
                <span id="auth-status" style="margin-left:12px; font-size:13px; color:#666;"></span>
            </div>
        </div>

        <div class="card">
            <div class="step">
                <h3>Step 2: Migrate Data</h3>
                <p>Load portfolio.json and write all items to Firestore.</p>
                <br>
                <button class="btn btn--primary" id="btn-migrate" onclick="doMigrate()" disabled>Start Migration</button>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom:12px;">Migration Log</h3>
            <div id="log">Waiting to start...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        var logEl = document.getElementById('log');

        function log(msg) {
            logEl.textContent += '\n' + msg;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function doLogin() {
            var email = document.getElementById('email').value;
            var password = document.getElementById('password').value;
            var statusEl = document.getElementById('auth-status');

            auth.signInWithEmailAndPassword(email, password).then(function(cred) {
                statusEl.textContent = 'Logged in as ' + cred.user.email;
                statusEl.style.color = '#27ae60';
                document.getElementById('btn-migrate').disabled = false;
                log('Authenticated successfully.');
            }).catch(function(err) {
                statusEl.textContent = 'Login failed: ' + err.message;
                statusEl.style.color = '#e74c3c';
                log('Login failed: ' + err.message);
            });
        }

        function doMigrate() {
            var btn = document.getElementById('btn-migrate');
            btn.disabled = true;
            btn.textContent = 'Migrating...';
            log('Starting migration...');

            fetch('data/portfolio.json').then(function(res) {
                return res.json();
            }).then(function(data) {
                var list = data.list;
                var details = data.details;
                log('Loaded portfolio.json: ' + list.length + ' items');

                // Process items sequentially using idx from list and details
                var promises = list.map(function(item, index) {
                    var idx = item.idx;
                    var detail = details[idx] || {};

                    var docData = {
                        idx: idx,
                        title: detail.title || item.title || '',
                        date: detail.date || item.date || '',
                        brand: detail.brand || item.brand || '',
                        thumbnail: item.thumbnail || detail.thumbnail || '',
                        type: item.type || detail.type || '',
                        subject: detail.subject || '',
                        detail_image_1: detail.detail_image_1 || '',
                        detail_image_2: detail.detail_image_2 || '',
                        order: index,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    return db.collection('portfolios').doc(idx).set(docData).then(function() {
                        log('[' + (index + 1) + '/' + list.length + '] Migrated: ' + docData.title);
                    });
                });

                return Promise.all(promises);
            }).then(function() {
                log('\n=== Migration complete! ===');
                btn.textContent = 'Done!';
            }).catch(function(err) {
                log('ERROR: ' + err.message);
                btn.textContent = 'Failed';
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
